<!--
 * @Author: your name
 * @Date: 2020-09-04 09:25:58
 * @LastEditTime: 2020-09-05 00:04:06
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \notebook\database\主流分布式存储.MD
-->

# 主流分布式存储技术

- 关系型数据库：**MySQL**,Oracle,DB2,sqlserver 等
- NoSQL 数据库: **Redis,MongoDB,HBase**等
- NewSQL 数据库: TiDB,**OceanBase**等
  [主流分布式存储技术](https://github.com/AmarsDing/notebook/tree/master/database/assert/1599135286.jpg)

## 关系型数据库的特点

**行存储**

- 1. 采用表格的存储方式，数据以行和列的方式进行存储
- 2. 按照结构化的方法存储数据，必须先定义好表的结构，再根据表的结构存入数据
- 3. 采用结构化查询语言(即 SQL)来对数据库进行查询
- 4. 强调 ACID 事务规则，适合对事务性要求较高或者需要进行复杂数据查询的数据操作

大数据场景下 IO 较高
结构存储 不够灵活
表结构 schema 扩展不方便，如果需要修改表结构，需要执行 DDL 语句修改，修改期间会导致锁表，部分服务不可用
全文搜索功能较弱 关系型数据库只能进行子字符串的匹配查询，当表的数据逐渐变大的时候，即使在有索引的情况下，like 扫描表查询的匹配会非常慢。
难以存储和处理复杂关系型数据， 传统的关系型数据库，并不擅长处理数据点之间的关系

**数据库事务正确执行的四个基本要素 ACID**

| 字符 |        名称        | 描述                                                                                                                         |
| :--: | :----------------: | :--------------------------------------------------------------------------------------------------------------------------- |
|  A   | Atomicity(原子性)  | 一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间环节结束，事务在执行过程中发生错误，会被回滚到事务开始的状态。 |
|  C   | Consistency 一致性 | 在事务开始之前和事务结束后，数据库的完整性没有遭到破坏                                                                       |
|  I   |  Isolation 隔离性  | 数据库允许多个并发事务同时对数据进行读写和修改的能力。隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致         |
|  D   | Durability 持久性  | 事务处理结束后，对数据的修改是永久的，即便系统故障也不会丢失                                                                 |

## NoSQL 数据库特点

> NoSQL 用于超大规模数据的存储；它具有非关系型、分布式、不提供 ACID 的数据库设计模式等特征
> NoSQL 不保证强一致性，对于普通应用没有问题，不太适合有强一致性的需求，例如金融类的应用。
> 不支持 SQL 语句，兼容性是个问题，不同的 NoSQL 都有自己的 API 操作；

- 1. 放弃了传统 SQL 的强事务保证和关系模型，重点放在数据库的高可用性和可扩展性。（MongoDB 最新支持事务）
- 2. 高可用性和可扩展性，自动分片，轻松扩展
- 3. 没有关系模型的限制，极其灵活

## NewSQL 数据库的特点

NewSQL 是最近新产生的，缺乏大规模实践经验，很多特性和处理能力介于关系型数据库和 NoSQL 数据库之间。

## SQL 与 NOSQL 对比

**NOSQL 对修改和删除支持不好，主要着重于查询和存储**

![区别](https://github.com/AmarsDing/notebook/tree/master/database/assert/v2-37a08f96c102ca39b99b5f746d33b914_r.jpg)

- **SQL 是精确的。** 他最适合于具有精确标准定义，明确的项目。

  > SQL 关系型数据库适合存储结构化数据
  >
  > > 如用户的帐号、地址等：

  > > 1）这些数据通常需要做结构化查询，比如 join，这时候，关系型数据库就要胜出一筹

  > > 2）这些数据的规模、增长的速度通常是可以预期的

  > > 3）保证数据的事务性、一致性要求。

- **NOSQL 是多变的** 他最适合具有不确定需求的数据。

  > NoSQL 适合存储非结构化数据
  >
  > > 如发微博、文章、评论：

  > > 1）这些数据通常用于模糊处理，如全文搜索、机器学习

  > > 2）这些数据是海量的，而且增长的速度是难以预期的，

  > > 3）根据数据的特点，NoSQL 数据库通常具有无限（至少接近）伸缩性

  > > 4）按 key 获取数据效率很高，但是对 join 或其他结构化查询的支持就比较差

  - 目前许多大型互联网项目都会选用 MySQL（或任何关系型数据库） + NoSQL 的组合方案。

## NoSQL 的常见类型和比较

**有四种常见的 NoSQL 数据库类型：列式、文档、图形和内存键值。**
![Nosql](https://github.com/AmarsDing/notebook/tree/master/database/assert/v2-751908e0546c036929f45a78f47c3bfd_720w.jpg)

### 1.列式数据

顾名思义，是按列存储数据的,主要适合于批量数据处理和即时查询。最大的特点是方便存储结构化和半结构化数据，方便做数据压缩，对针对某一列或者某几列的查询有非常大的 IO 优势。

1）对应的 nosql： HBase,BigTable 等。

2）典型应用场景：按列存储，针对某一列或者某几列的查询有非常大的 IO 优势。

3）优点：查找速度快，可扩展性强，更容易进行分布式扩展。

4）缺点：功能相对局限。

#### 1.1 基本原理

> 传统关系型数据库是按照行来存储数据库，称为行式数据库，而列式数据库是按照列来存储数据。
> 将表放入存储系统中有两种方法，而我们绝大部分是采用 行存储 的。
> 行存储法是将 各行 放入 连续的物理位置, 这很像传统的记录和文件系统。
> 列存储法 是将数据 按照列 存储到数据库中，与 行存储 类似，下图是两种存储方法的图形化解释：
> ![行列存储](https://github.com/AmarsDing/notebook/tree/master/database/assert/1657fcb6c029cd0c.jpg)

### 1.2 常见列式数据库

**HBase**

> HBase 是一个开源的 非关系型分布式数据库（NoSQL），它参考了 谷歌 的 BigTable 建模，实现的编程语言为 Java。
> 它是 Apache 软件基金会的 Hadoop 项目的一部分，运行于 HDFS 文件系统之上，为 Hadoop 提供类似于 BigTable 规模的服务。因此，它可以 容错地 存储 海量稀疏 的数据。

**BigTable**
BigTable 是一种 压缩的、高性能的、高可扩展性的，基于 Google 文件系统（Google File System，GFS）的数据存储系统，用于存储 大规模结构化数据，适用于云计算。

### 1.3 相关特性

> **高效的储存空间利用率**

> 列式数据库 针对不同列的 数据特征 而发明了 不同算法，使其比 行式数据库 高的多的 压缩率。
> 普通的 行式数据库 一般压缩率在 3：1 到 5：1 左右，而 列式数据库 的压缩率一般在 8：1 到 30：1 左右。
> 比较常见的，通过 字典表 压缩数据：

[行列压缩](https://github.com/AmarsDing/notebook/tree/master/database/assert/1657fcb6c05cfd1a.jpg)

> **下面才是那张表本来的样子。经过 字典表 进行 数据压缩 后，表中的 字符串 才都变成 数字。正因为每个字符>串在 字典表 里只 出现了一次，所以达到了 压缩 的目的。**

> **查询效率高**

读取多条数据的 同一列效率高，因为这些列都是 存储在一起的，一次磁盘操作可以数据的 指定列 全部读取到 内存 中。 下图通过 一条查询 的执行过程说明 列式存储 （以及 数据压缩）的优点。

![数据压缩](https://github.com/AmarsDing/notebook/tree/master/database/assert/1657fcb6c2af193f.jpg)

执行步骤如下：

> 1.  去 **字典表** 里找到**字符串对应数字**（只进行一次字符串比较）。
> 2.  用 **数字** 去列表里匹配，匹配上的位置设为 1。
> 3.  把 **不同列** 的 **匹配结果** 进行**位运算** 得到符合所有条件的 **记录下标**。
> 4.  使用这个 **下标组装** 出最终的 **结果集**。

- **适合做聚合操作**

- **适合大量的数据而不是小数据**

- **不适合扫描 小量数据**

- **不适合 随机的更新**

- **不适合做含有删除和更新的 实时操作**

- **单行数据 支持 ACID 的 事务操作，多行数据 的 事务操作，不支持事务的 正常回滚，支持 （Isolation）隔离性、(Durability）持久性，不能保证 (Atomicity）原子性、（Consistency）一致性。**

### 1.4 场景应用

列数据库的适用场景，以 HBase 为例说明：

> 适合 大数据量 (100TB 级数据），有 快速随机访问 的需求。

> 适合 写密集型 应用，每天写入量巨大，而 读数量相对较小 的应用，比如 IM 的 历史消息，游戏日志 等等。

> 适合不需要 复杂查询 条件来查询数据的应用。HBase 只支持基于 rowkey 的查询，对于 HBase 来说，单条记录 或者 小范围的查询 是可以接受的。大范围 的查询由于 分布式 的原因，可能在 性能 上有点影响。HBase 不适用于有 join，多级索引，表关系复杂 的数据模型。

> 对 性能 和 可靠性 要求非常高的应用。

> 由于 HBase 本身没有 单点故障，可用性 非常高。

> 适合 数据量较大，而且 增长量 无法预估的应用，需要进行优雅的数据扩展的应用。HBase 支持 在线扩展，即使在一段时间内，数据量呈 井喷式增长，也可以通过 HBase 横向扩展 来满足功能。

> 存储 结构化 和 半结构化 的数据。

### 2.文档数据库

旨在将半结构化数据存储为文档，通常采用 JSON 或 XML 格式。与传统关系数据库不同的是，每个 NoSQL 文档的架构是不同的，可让您更加灵活地整理和存储应用程序数据并减少可选值所需的存储。

1）对应的 nosql：CouchDB, MongoDb

2）典型应用场景：存储类似 JSON 格式的内容，可对某些字段建立索引功能，是最像关系型的数据库。

3）优点：数据结构要求不严格，表结构可变，不需要像关系型数据库一样需要预先定义表结构。

4）缺点：查询性能不高，而且缺乏统一的查询语法。

### 3.图形数据库

可存储顶点以及称为边缘的直接链路。图形数据库可以在 SQL 和 NoSQL 数据库上构建。顶点和边缘可以拥有各自的相关属性。

1）数据模型：图结构

2）典型应用场景：社交网络，推荐系统等。专注于构建关系图谱，善于处理大量复杂、互连接、低结构化的数据，数据往往变化迅速，且查询频繁。

3）优点：利用图结构相关算法。比如最短路径寻址，N 度关系查找等。

4）缺点：很多时候需要对整个图做计算才能得出需要的信息，而且这种结构不太好做分布式的集群方案。

### 4.内存键值对存储

可以通过 key 快速查询到其 value。一般来说，存储不管 value 的格式，照单全收，是针对读取密集型应用程序工作负载（例如社交网络、游戏、媒体共享和 Q&A 门户）。内存缓存可将重要数据存储在内存中以实现低延迟访问，从而提高应用程序性能。

1）对应的 nosql：Redis,Memcached 等

2）典型应用场景：内容缓存，主要用于处理大量数据的高访问负载，也用于一些日志系统等等。

3）优点：查找速度快。

4）缺点：数据无结构化，通常只被当作字符串或者二进制数据。

## SQL,NoSQL,NewSQL 特点

![能力图](https://github.com/AmarsDing/notebook/tree/master/database/assert/1599136040.jpg)

## SQL, NoSQL, NewSQL 选型

![选型](https://github.com/AmarsDing/notebook/tree/master/database/assert/1599136267.jpg)
![架构选型](https://github.com/AmarsDing/notebook/tree/master/database/assert/1599136618.jpg)
